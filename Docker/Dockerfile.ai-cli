FROM node:22-bookworm-slim

ARG ARG_UV_VERSION
ARG ARG_PLAYWRIGHT_MCP_VERSION
ARG ARG_PYTHON_VERSION

# Basics + socat for the codex login bridge
RUN apt-get update && apt-get install -y --no-install-recommends \
    git ca-certificates bash curl socat wget jq sudo vim unzip gpg gnupg apt-transport-https lsb-release && \
    rm -rf /var/lib/apt/lists/*

# Install GitHub CLI
RUN mkdir -p -m 755 /etc/apt/keyrings && \
    wget -qO /etc/apt/keyrings/githubcli-archive-keyring.gpg https://cli.github.com/packages/githubcli-archive-keyring.gpg && \
    chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list && \
    apt-get update && apt-get install -y --no-install-recommends gh && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install uv
RUN wget -qO- https://astral.sh/uv/${ARG_UV_VERSION}/install.sh | sh && \
    cp /root/.local/bin/uv /usr/local/bin/uv && \
    cp /root/.local/bin/uvx /usr/local/bin/uvx

ENV UV_PYTHON_INSTALL_DIR=/opt/python

# Install Python using uv
RUN uv python install --install-dir /opt/python ${ARG_PYTHON_VERSION}

# Create a default virtual environment
RUN uv venv /opt/venv
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install pip into the venv so pip commands work
RUN uv pip install pip

# Install ALL CLIs
RUN npm i -g @anthropic-ai/claude-code @openai/codex @github/copilot

# Playwright MCP + browsers (Chromium only to keep the image smaller)
RUN npm i -g @playwright/mcp@${ARG_PLAYWRIGHT_MCP_VERSION} \
    && npx -p @playwright/mcp@${ARG_PLAYWRIGHT_MCP_VERSION} playwright install --with-deps chromium

# Copy MCP configuration files
COPY mcp /opt/mcp

# Copy extensions directory and install custom Python packages
COPY extensions /opt/extensions
RUN if [ -s /opt/extensions/requirements.txt ]; then \
        echo "Installing packages from requirements.txt..." && \
        uv pip install -r /opt/extensions/requirements.txt; \
    fi && \
    if ls /opt/extensions/packages/*.whl 1> /dev/null 2>&1; then \
        echo "Installing wheel files from packages/..." && \
        uv pip install /opt/extensions/packages/*.whl; \
    fi

# Create non-root user and set permissions
RUN useradd -m -s /bin/bash aiuser && \
    chown -R aiuser:aiuser /opt/venv /opt/python /opt/mcp /opt/extensions

# Switch to non-root user
USER aiuser

# Workdir; no ENTRYPOINT (set per service in compose)
WORKDIR /workspace
