FROM node:22-bookworm-slim

ARG ARG_UV_VERSION
ARG ARG_PLAYWRIGHT_MCP_VERSION
ARG ARG_PYTHON_VERSION

# Basics + socat for the codex login bridge
RUN apt-get update && apt-get install -y --no-install-recommends \
    git ca-certificates bash curl socat wget jq && \
    rm -rf /var/lib/apt/lists/*

# Install uv
RUN wget -qO- https://astral.sh/uv/${ARG_UV_VERSION}/install.sh | sh && \
    cp /root/.local/bin/uv /usr/local/bin/uv && \
    cp /root/.local/bin/uvx /usr/local/bin/uvx

ENV UV_PYTHON_INSTALL_DIR=/opt/python

# Install Python using uv and create symlinks for python/python3
RUN uv python install --install-dir /opt/python ${ARG_PYTHON_VERSION} && \
    UV_PYTHON_PATH=$(uv python find ${ARG_PYTHON_VERSION}) && \
    UV_PYTHON_DIR=$(dirname "$UV_PYTHON_PATH") && \
    ln -sf "$UV_PYTHON_PATH" /usr/bin/python && \
    ln -sf "$UV_PYTHON_PATH" /usr/bin/python3 && \
    ln -sf "$UV_PYTHON_DIR/pip" /usr/bin/pip 2>/dev/null || true && \
    ln -sf "$UV_PYTHON_DIR/pip3" /usr/bin/pip3 2>/dev/null || true

# Install ALL CLIs
RUN npm i -g @anthropic-ai/claude-code @openai/codex @github/copilot

# Playwright MCP + browsers (Chromium only to keep the image smaller)
RUN npm i -g @playwright/mcp@${ARG_PLAYWRIGHT_MCP_VERSION} \
    && npx -p @playwright/mcp@${ARG_PLAYWRIGHT_MCP_VERSION} playwright install --with-deps chromium

# Copy MCP configuration files
COPY mcp /opt/mcp

RUN UV_PYTHON_PATH=$(uv python find ${ARG_PYTHON_VERSION})

# Copy extensions directory and install custom Python packages
COPY extensions /opt/extensions
RUN if [ -s /opt/extensions/requirements.txt ]; then \
        echo "Installing packages from requirements.txt..." && \
        uv pip install --system --break-system-packages -r /opt/extensions/requirements.txt; \
    fi && \
    if ls /opt/extensions/packages/*.whl 1> /dev/null 2>&1; then \
        echo "Installing wheel files from packages/..." && \
        uv pip install --system --break-system-packages /opt/extensions/packages/*.whl; \
    fi

# Workdir; no ENTRYPOINT (set per service in compose)
WORKDIR /workspace
